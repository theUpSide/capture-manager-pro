<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>Capture Manager Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        nav {
            display: flex;
            gap: 2rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #2a5298;
        }

        .metric-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2a5298;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #1e3c72;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .opportunity-list {
            padding: 0;
        }

        .opportunity-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 1rem;
            align-items: center;
        }

        .opportunity-item:last-child {
            border-bottom: none;
        }

        .opportunity-info h4 {
            color: #333;
            margin-bottom: 0.3rem;
        }

        .opportunity-details {
            color: #666;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-identification { background: #e2e3e5; color: #383d41; }
        .status-qualification { background: #fff3cd; color: #856404; }
        .status-planning { background: #cce5ff; color: #004085; }
        .status-engagement { background: #d4edda; color: #155724; }
        .status-intelligence { background: #f8d7da; color: #721c24; }
        .status-preparation { background: #e2e3e5; color: #383d41; }

        .progress-indicator {
            width: 80px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
            transition: width 0.3s ease;
        }

        .pwin-indicator {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }

        .pwin-high { color: #28a745; }
        .pwin-medium { color: #ffc107; }
        .pwin-low { color: #dc3545; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .actions-section {
            padding: 1.5rem;
        }

        .action-item {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-item.urgent {
            border-left-color: #dc3545;
        }

        .action-item.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .next-actions-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .next-actions-widget h3 {
            margin-bottom: 1rem;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }

        .template-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: white;
            transition: box-shadow 0.3s;
        }

        .template-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .template-card h4 {
            color: #2a5298;
            margin-bottom: 0.5rem;
        }

        .template-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .roadmap-controls {
            display: flex;
            gap: 1rem;
        }

        .roadmap-timeline {
            margin-top: 2rem;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .timeline-header {
            display: grid;
            grid-template-columns: 350px 1fr;
            background-color: #2a5298;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .opportunity-column-header {
            padding: 1rem;
            border-right: 1px solid rgba(255,255,255,0.2);
            background-color: #2a5298;
        }

        .phase-columns-header {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
        }

        .phase-header-item {
            padding: 1rem 0.5rem;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
        }

        .phase-header-item:last-child {
            border-right: none;
        }

        .timeline-rows {
            background: white;
        }

        .timeline-row {
            display: grid;
            grid-template-columns: 350px 1fr;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }

        .timeline-row:hover {
            background-color: #f8f9fa;
        }

        .timeline-row:last-child {
            border-bottom: none;
        }

        .opportunity-info-cell {
            padding: 1.5rem;
            border-right: 1px solid #e9ecef;
            background: white;
        }

        .opp-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .opp-details {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
            margin-bottom: 0.8rem;
        }

        .opp-metrics {
            display: flex;
            gap: 0.5rem;
            font-size: 0.7rem;
            flex-wrap: wrap;
        }

        .metric-badge {
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .metric-badge.value {
            background: #e8f5e9;
            border-color: #28a745;
            color: #155724;
        }

        .metric-badge.pwin-high {
            background: #e8f5e9;
            border-color: #28a745;
            color: #155724;
        }

        .metric-badge.pwin-medium {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .metric-badge.pwin-low {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .phase-blocks-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
        }

        .phase-block {
            padding: 1.2rem 0.6rem;
            border-right: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .phase-block:last-child {
            border-right: none;
        }

        .phase-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .phase-block.completed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
        }

        .phase-block.current {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
            animation: currentPhase 2s infinite;
        }

        .phase-block.upcoming {
            background: #f8f9fa;
            border-left: 4px solid #e9ecef;
        }

        .phase-block.needs-attention {
            background: linear-gradient(135deg, #ffe4b5 0%, #ffd700 100%);
            border-left: 4px solid #ff8c00;
            animation: attentionPhase 2.5s infinite;
        }

        @keyframes currentPhase {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes attentionPhase {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .phase-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }

        .phase-progress {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .phase-status {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: bold;
        }

        .timeline-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .legend-completed { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .legend-current { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); }
        .legend-upcoming { background: #f8f9fa; }
        .legend-attention { background: linear-gradient(135deg, #ffe4b5 0%, #ffd700 100%); }

        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: pre-line;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            max-width: 200px;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .phase-block:hover .tooltip {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .opportunity-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .timeline-header {
                grid-template-columns: 250px 1fr;
            }

            .timeline-row {
                grid-template-columns: 250px 1fr;
            }

            .opportunity-column-header {
                padding: 0.8rem;
            }

            .opportunity-info-cell {
                padding: 1rem;
            }

            .phase-header-item {
                padding: 0.6rem 0.3rem;
                font-size: 0.6rem;
            }

            .phase-block {
                padding: 0.8rem 0.4rem;
                min-height: 80px;
            }

            .phase-icon {
                font-size: 1.2rem;
            }

            .opp-metrics {
                flex-direction: column;
                gap: 0.3rem;
            }

            .timeline-legend {
                flex-direction: column;
                gap: 0.8rem;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>🎯 Capture Manager Pro</h1>
        <nav>
            <a href="#" class="active" onclick="showDashboard()">Dashboard</a>
            <a href="#" onclick="showOpportunities()">Opportunities</a>
            <a href="#" onclick="showRoadmap()">Roadmap</a>
            <a href="#" onclick="showActions()">Action Items</a>
            <a href="#" onclick="showTemplates()">Templates</a>
            <a href="#" onclick="showReports()">Reports</a>
        </nav>
    </header>

    <div class="container">
        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Pipeline</h3>
                    <div class="metric-value" id="total-pipeline">$0</div>
                </div>
                <div class="metric-card">
                    <h3>Weighted Pipeline</h3>
                    <div class="metric-value" id="weighted-pipeline">$0</div>
                </div>
                <div class="metric-card">
                    <h3>Active Opportunities</h3>
                    <div class="metric-value" id="active-count">0</div>
                </div>
                <div class="metric-card">
                    <h3>Average Progress</h3>
                    <div class="metric-value" id="avg-progress">0%</div>
                </div>
            </div>

            <div class="next-actions-widget">
                <h3>🚀 Smart Recommendations</h3>
                <div id="smart-recommendations">
                    <!-- AI-powered recommendations will appear here -->
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Active Opportunities</h2>
                    <button class="btn" onclick="openNewOpportunityModal()">+ Add Opportunity</button>
                </div>
                <div class="opportunity-list" id="opportunity-list">
                    <!-- Opportunities will be populated here -->
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Urgent Action Items</h2>
                    <button class="btn btn-secondary" onclick="showActions()">View All</button>
                </div>
                <div class="actions-section" id="urgent-actions">
                    <!-- Urgent actions will be populated here -->
                </div>
            </div>
        </div>

        <!-- Roadmap View -->
        <div id="roadmap-view" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>Capture Management Roadmap</h2>
                    <div class="roadmap-controls">
                        <button class="btn" onclick="refreshRoadmapView()">🔄 Refresh</button>
                        <button class="btn btn-secondary" onclick="exportRoadmap()">📊 Export</button>
                    </div>
                </div>
                
                <!-- Visual Timeline Roadmap -->
                <div class="roadmap-timeline">
                    <div class="timeline-header">
                        <div class="opportunity-column-header">Opportunities</div>
                        <div class="phase-columns-header">
                            <div class="phase-header-item">Identification</div>
                            <div class="phase-header-item">Qualification</div>
                            <div class="phase-header-item">Planning</div>
                            <div class="phase-header-item">Engagement</div>
                            <div class="phase-header-item">Intelligence</div>
                            <div class="phase-header-item">Preparation</div>
                        </div>
                    </div>
                    
                    <div class="timeline-rows" id="roadmap-timeline-rows">
                        <!-- Timeline rows will be populated here -->
                    </div>

                    <div class="timeline-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-completed"></div>
                            <span>✅ Completed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-current"></div>
                            <span>🔄 Current Phase</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-upcoming"></div>
                            <span>⏳ Upcoming</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-attention"></div>
                            <span>🎯 Needs Attention</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates View -->
        <div id="templates-view" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>Capture Management Templates</h2>
                    <button class="btn" onclick="openNewTemplateModal()">+ Add Template</button>
                </div>
                <div class="templates-grid" id="templates-grid">
                    <!-- Templates will be populated here -->
                </div>
            </div>
        </div>

        <!-- Opportunities View -->
        <div id="opportunities-view" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>All Opportunities</h2>
                    <button class="btn" onclick="openNewOpportunityModal()">+ Add Opportunity</button>
                </div>
                <div class="opportunity-list" id="all-opportunities">
                    <!-- All opportunities will be populated here -->
                </div>
            </div>
        </div>

        <!-- Actions View -->
        <div id="actions-view" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>Action Items</h2>
                    <button class="btn" onclick="openNewActionModal()">+ Add Action</button>
                </div>
                <div class="actions-section" id="all-actions">
                    <!-- All actions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Opportunity Modal -->
    <div id="opportunityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Add New Opportunity</h2>
            <form id="opportunityForm" onsubmit="saveOpportunity(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="oppName">Opportunity Name *</label>
                        <input type="text" id="oppName" required>
                    </div>
                    <div class="form-group">
                        <label for="oppCustomer">Customer *</label>
                        <input type="text" id="oppCustomer" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="oppValue">Contract Value ($)</label>
                        <input type="number" id="oppValue" min="0">
                    </div>
                    <div class="form-group">
                        <label for="oppType">Opportunity Type</label>
                        <select id="oppType">
                            <option value="RFP">RFP - Request for Proposal</option>
                            <option value="IDIQ">IDIQ - Indefinite Delivery</option>
                            <option value="SBIR">SBIR - Small Business Innovation</option>
                            <option value="Sole Source">Sole Source</option>
                            <option value="GSA Schedule">GSA Schedule</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="oppRfpDate">Expected RFP Date</label>
                        <input type="date" id="oppRfpDate">
                    </div>
                    <div class="form-group">
                        <label for="oppPwin">Probability of Win (%)</label>
                        <input type="number" id="oppPwin" min="0" max="100" value="50">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="oppRole">Our Role</label>
                        <select id="oppRole">
                            <option value="Prime">Prime Contractor</option>
                            <option value="Sub">Subcontractor</option>
                            <option value="Partner">Teaming Partner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="oppIncumbent">Incumbent</label>
                        <input type="text" id="oppIncumbent" placeholder="Current contractor (if recompete)">
                    </div>
                </div>
                <div class="form-group">
                    <label for="oppDescription">Description</label>
                    <textarea id="oppDescription"></textarea>
                </div>
                <button type="submit" class="btn">Save Opportunity</button>
            </form>
        </div>
    </div>

    <!-- Add Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActionModal()">&times;</span>
            <h2>Add Action Item</h2>
            <form id="actionForm" onsubmit="saveAction(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="actionTitle">Action Title *</label>
                        <input type="text" id="actionTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="actionOpportunity">Opportunity *</label>
                        <select id="actionOpportunity" required>
                            <option value="">Select Opportunity</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="actionDueDate">Due Date *</label>
                        <input type="date" id="actionDueDate" required>
                    </div>
                    <div class="form-group">
                        <label for="actionPriority">Priority</label>
                        <select id="actionPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="actionPhase">Phase</label>
                        <select id="actionPhase">
                            <option value="identification">Identification</option>
                            <option value="qualification">Qualification</option>
                            <option value="planning">Planning</option>
                            <option value="engagement">Engagement</option>
                            <option value="intelligence">Intelligence</option>
                            <option value="preparation">Preparation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="actionCategory">Category</label>
                        <select id="actionCategory">
                            <option value="research">Research</option>
                            <option value="meeting">Meeting</option>
                            <option value="analysis">Analysis</option>
                            <option value="documentation">Documentation</option>
                            <option value="coordination">Coordination</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="actionDescription">Description</label>
                    <textarea id="actionDescription" placeholder="Additional details about this action..."></textarea>
                </div>
                <button type="submit" class="btn">Save Action</button>
            </form>
        </div>
    </div>

    <!-- Opportunity Detail Modal -->
    <div id="opportunityDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOpportunityDetailModal()">&times;</span>
            <div id="opportunity-detail-content">
                <!-- Opportunity details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Phase Detail Modal -->
    <div id="phaseDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePhaseModal()">&times;</span>
            <div id="phase-detail-content">
                <!-- Phase details will be populated here -->
            </div>
        </div>
    </div>

<!-- Add a new Templates Detail Modal after the existing modals -->
<div id="templateDetailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTemplateDetailModal()">&times;</span>
        <div id="template-detail-content">
            <!-- Template form will be populated here -->
        </div>
    </div>
</div>

<!-- Add a Saved Templates View -->
<div id="saved-templates-view" style="display:none;">
    <div class="section">
        <div class="section-header">
            <h2>Saved Templates</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="showTemplates()">Back to Templates</button>
                <button class="btn" onclick="clearAllSavedTemplates()">Clear All</button>
            </div>
        </div>
        <div class="templates-grid" id="saved-templates-grid">
            <!-- Saved templates will be populated here -->
        </div>
    </div>
</div>

    <script>
        // Enhanced data structures
        let opportunities = [
            {
                id: 1,
                name: "Japan AWACS E-767 Radio Upgrade",
                customer: "Japan Air Self-Defense Force",
                value: 25000000,
                rfpDate: "2025-03-01",
                pwin: 85,
                type: "IDIQ",
                role: "Sub",
                incumbent: "Boeing",
                currentPhase: "preparation",
                progress: 85,
                description: "Real-time information in cockpit system integration",
                createdDate: "2024-08-20"
            }
        ];

        let actions = [
            {
                id: 1,
                opportunityId: 1,
                title: "Complete competitive analysis for Hitachi partnership",
                dueDate: "2025-01-05",
                priority: "High",
                phase: "intelligence",
                stepId: "black-hat-analysis",
                completed: false
            },
            {
                id: 2,
                opportunityId: 1,
                title: "Schedule customer demo at Edwards AFB",
                dueDate: "2025-01-10",
                priority: "Medium",
                phase: "engagement",
                stepId: "technical-exchange",
                completed: false
            },
            {
                id: 3,
                opportunityId: 2,
                title: "Conduct Black Hat review session",
                dueDate: "2025-01-08",
                priority: "High",
                phase: "intelligence",
                stepId: "black-hat-analysis",
                completed: false
            }
        ];

// Enhanced template definitions with form fields
let templates = [
    {
        id: 1,
        title: "Capture Plan Template",
        description: "Comprehensive capture plan following Shipley methodology",
        category: "Planning",
        fields: [
            { id: "program_name", label: "Program/Project Name", type: "text", required: true },
            { id: "customer", label: "Customer", type: "text", required: true },
            { id: "contract_type", label: "Contract Type & Duration", type: "text", required: true },
            { id: "estimated_value", label: "Estimated Value ($)", type: "number", required: true },
            { id: "rfp_date", label: "RFP Release Date", type: "date", required: false },
            { id: "award_date", label: "Award Date", type: "date", required: false },
            { id: "key_stakeholders", label: "Key Stakeholders", type: "textarea", required: true },
            { id: "decision_process", label: "Decision Process", type: "textarea", required: true },
            { id: "hot_buttons", label: "Customer Hot Buttons", type: "textarea", required: true },
            { id: "pain_points", label: "Current Pain Points", type: "textarea", required: true },
            { id: "primary_competitors", label: "Primary Competitors", type: "textarea", required: true },
            { id: "competitive_strengths", label: "Our Competitive Strengths", type: "textarea", required: true },
            { id: "competitive_weaknesses", label: "Our Competitive Weaknesses", type: "textarea", required: true },
            { id: "differentiation", label: "Differentiation Strategy", type: "textarea", required: true },
            { id: "win_themes", label: "Primary Win Themes", type: "textarea", required: true },
            { id: "discriminators", label: "Key Discriminators", type: "textarea", required: true },
            { id: "value_proposition", label: "Value Proposition", type: "textarea", required: true },
            { id: "critical_activities", label: "Critical Path Activities", type: "textarea", required: true },
            { id: "resource_requirements", label: "Resource Requirements", type: "textarea", required: true },
            { id: "risk_mitigation", label: "Risk Mitigation", type: "textarea", required: true }
        ]
    },
    {
        id: 2,
        title: "Competitor Profile Template",
        description: "Detailed competitor analysis framework",
        category: "Intelligence",
        fields: [
            { id: "competitor_name", label: "Competitor Name", type: "text", required: true },
            { id: "company_overview", label: "Company Overview", type: "textarea", required: true },
            { id: "financial_health", label: "Financial Health", type: "select", options: ["Strong", "Moderate", "Weak", "Unknown"], required: true },
            { id: "past_performance", label: "Past Performance with Customer", type: "textarea", required: true },
            { id: "technical_capabilities", label: "Technical Capabilities", type: "textarea", required: true },
            { id: "key_personnel", label: "Key Personnel", type: "textarea", required: true },
            { id: "teaming_partners", label: "Known Teaming Partners", type: "textarea", required: false },
            { id: "strengths", label: "Competitive Strengths", type: "textarea", required: true },
            { id: "weaknesses", label: "Competitive Weaknesses", type: "textarea", required: true },
            { id: "likely_strategy", label: "Likely Bid Strategy", type: "textarea", required: true },
            { id: "pricing_approach", label: "Expected Pricing Approach", type: "textarea", required: true },
            { id: "win_probability", label: "Their Win Probability (%)", type: "number", min: 0, max: 100, required: true }
        ]
    },
    {
        id: 3,
        title: "Customer Meeting Report",
        description: "Structured format for capturing customer interactions",
        category: "Engagement",
        fields: [
            { id: "meeting_date", label: "Meeting Date", type: "date", required: true },
            { id: "meeting_type", label: "Meeting Type", type: "select", options: ["In-Person", "Virtual", "Phone", "Conference"], required: true },
            { id: "customer_attendees", label: "Customer Attendees", type: "textarea", required: true },
            { id: "our_attendees", label: "Our Attendees", type: "textarea", required: true },
            { id: "meeting_purpose", label: "Meeting Purpose", type: "textarea", required: true },
            { id: "key_discussion_points", label: "Key Discussion Points", type: "textarea", required: true },
            { id: "customer_feedback", label: "Customer Feedback", type: "textarea", required: true },
            { id: "action_items", label: "Action Items", type: "textarea", required: true },
            { id: "follow_up_required", label: "Follow-up Required", type: "textarea", required: false },
            { id: "intelligence_gathered", label: "Intelligence Gathered", type: "textarea", required: true },
            { id: "relationship_assessment", label: "Relationship Assessment", type: "select", options: ["Excellent", "Good", "Fair", "Poor"], required: true },
            { id: "next_steps", label: "Next Steps", type: "textarea", required: true }
        ]
    },
    {
        id: 4,
        title: "Teaming Agreement Checklist",
        description: "Key elements for teaming partnerships",
        category: "Planning",
        fields: [
            { id: "partner_name", label: "Partner Company Name", type: "text", required: true },
            { id: "partnership_type", label: "Partnership Type", type: "select", options: ["Prime-Sub", "Joint Venture", "Mentor-Protege", "Other"], required: true },
            { id: "partner_role", label: "Partner Role/Responsibilities", type: "textarea", required: true },
            { id: "work_share", label: "Work Share (%)", type: "number", min: 0, max: 100, required: true },
            { id: "key_capabilities", label: "Key Capabilities Brought", type: "textarea", required: true },
            { id: "past_performance", label: "Relevant Past Performance", type: "textarea", required: true },
            { id: "points_of_contact", label: "Key Points of Contact", type: "textarea", required: true },
            { id: "agreement_status", label: "Agreement Status", type: "select", options: ["Verbal", "MOU Signed", "Teaming Agreement Signed", "Not Started"], required: true },
            { id: "ip_considerations", label: "IP/Proprietary Considerations", type: "textarea", required: false },
            { id: "risk_factors", label: "Risk Factors", type: "textarea", required: true }
        ]
    }
];
        

// Add to the existing data structures
let savedTemplates = JSON.parse(localStorage.getItem('savedTemplates')) || [];



        // Comprehensive roadmap definition
        const captureRoadmap = {
            identification: {
                title: "Opportunity Identification",
                description: "Discover and initially assess opportunities",
                steps: [
                    { id: "discovery", title: "Opportunity Discovery", description: "Monitor SAM.gov, GovWin, industry sources", daysFromStart: 0, duration: 3 },
                    { id: "initial-assessment", title: "Initial Assessment", description: "Review scope, customer, timeline", daysFromStart: 1, duration: 2 },
                    { id: "strategic-fit", title: "Strategic Fit Analysis", description: "Evaluate alignment with company goals", daysFromStart: 3, duration: 2 },
                    { id: "competitive-scan", title: "Competitive Landscape Scan", description: "Identify likely competitors", daysFromStart: 4, duration: 3 }
                ]
            },
            qualification: {
                title: "Opportunity Qualification",
                description: "Formal bid/no-bid decision process",
                steps: [
                    { id: "customer-relationship", title: "Customer Relationship Assessment", description: "Evaluate existing relationships and access", daysFromStart: 7, duration: 2 },
                    { id: "capability-gap", title: "Technical Capability Analysis", description: "Assess our ability to perform", daysFromStart: 8, duration: 3 },
                    { id: "bid-no-bid", title: "Bid/No-Bid Decision", description: "Formal scoring and recommendation", daysFromStart: 10, duration: 2 },
                    { id: "pursuit-authorization", title: "Pursuit Authorization", description: "Leadership approval and resources", daysFromStart: 12, duration: 1 }
                ]
            },
            planning: {
                title: "Capture Planning",
                description: "Develop comprehensive capture strategy",
                steps: [
                    { id: "team-assembly", title: "Capture Team Assembly", description: "Assign roles and responsibilities", daysFromStart: 14, duration: 2 },
                    { id: "capture-plan", title: "Initial Capture Plan", description: "Document strategy and approach", daysFromStart: 16, duration: 5 },
                    { id: "customer-research", title: "Customer Research Deep Dive", description: "Stakeholder mapping and analysis", daysFromStart: 18, duration: 7 },
                    { id: "requirements-analysis", title: "Requirements Analysis", description: "Parse known requirements", daysFromStart: 21, duration: 5 },
                    { id: "teaming-strategy", title: "Initial Teaming Strategy", description: "Prime vs sub, partner identification", daysFromStart: 25, duration: 3 }
                ]
            },
            engagement: {
                title: "Customer Engagement",
                description: "Build relationships and shape opportunity",
                steps: [
                    { id: "engagement-plan", title: "Customer Engagement Plan", description: "Strategic outreach planning", daysFromStart: 30, duration: 3 },
                    { id: "industry-day", title: "Industry Day Participation", description: "Attend and engage strategically", daysFromStart: 35, duration: 1 },
                    { id: "customer-meetings", title: "One-on-One Customer Meetings", description: "Program office and stakeholder meetings", daysFromStart: 40, duration: 14 },
                    { id: "rfi-response", title: "RFI Response Preparation", description: "Shape requirements through responses", daysFromStart: 50, duration: 7 },
                    { id: "technical-exchange", title: "Technical Exchange Meetings", description: "Demonstrate capabilities", daysFromStart: 60, duration: 5 }
                ]
            },
            intelligence: {
                title: "Competitive Intelligence",
                description: "Analyze competition and refine strategy",
                steps: [
                    { id: "competitive-intel", title: "Competitive Intelligence Gathering", description: "Deep research on competitors", daysFromStart: 70, duration: 10 },
                    { id: "black-hat-analysis", title: "Black Hat Analysis Session", description: "Role-play competitor strategies", daysFromStart: 80, duration: 2 },
                    { id: "win-strategy", title: "Win Strategy Workshop", description: "Define themes and discriminators", daysFromStart: 85, duration: 2 },
                    { id: "solution-architecture", title: "Solution Architecture", description: "Technical approach design", daysFromStart: 90, duration: 10 },
                    { id: "price-to-win", title: "Price-to-Win Analysis", description: "Competitive pricing strategy", daysFromStart: 100, duration: 5 }
                ]
            },
            preparation: {
                title: "Pre-RFP Preparation",
                description: "Final preparations before RFP release",
                steps: [
                    { id: "teaming-finalization", title: "Teaming Agreement Finalization", description: "Lock in partnerships", daysFromStart: 110, duration: 7 },
                    { id: "gate-review", title: "Capture Gate Review", description: "Leadership strategy validation", daysFromStart: 120, duration: 1 },
                    { id: "proposal-team", title: "Proposal Team Assembly", description: "Assign proposal roles", daysFromStart: 125, duration: 3 },
                    { id: "past-performance", title: "Past Performance Package", description: "Gather relevant examples", daysFromStart: 130, duration: 5 },
                    { id: "capture-handoff", title: "Capture-to-Proposal Handoff", description: "Transfer knowledge and strategy", daysFromStart: 140, duration: 2 }
                ]
            }
        };

        // Navigation functions
        function showDashboard() {
            hideAllViews();
            document.getElementById('dashboard-view').style.display = 'block';
            updateActiveNav('Dashboard');
            refreshDashboard();
        }

        function showOpportunities() {
            hideAllViews();
            document.getElementById('opportunities-view').style.display = 'block';
            updateActiveNav('Opportunities');
            renderAllOpportunities();
        }

        function showRoadmap() {
            hideAllViews();
            document.getElementById('roadmap-view').style.display = 'block';
            updateActiveNav('Roadmap');
            renderRoadmapTimeline();
        }

        function showActions() {
            hideAllViews();
            document.getElementById('actions-view').style.display = 'block';
            updateActiveNav('Action Items');
            renderAllActions();
        }

        // Update the navigation to include saved templates
function showTemplates() {
    hideAllViews();
    document.getElementById('templates-view').style.display = 'block';
    updateActiveNav('Templates');
    renderTemplates();
}

function showSavedTemplates() {
    hideAllViews();
    document.getElementById('saved-templates-view').style.display = 'block';
    updateActiveNav('Templates');
    renderSavedTemplates();
}

// Enhanced template rendering
// Update the renderTemplates function to be more defensive:
function renderTemplates() {
    const container = document.getElementById('templates-grid');
    
    // Ensure savedTemplates is properly loaded
    if (!savedTemplates) {
        savedTemplates = JSON.parse(localStorage.getItem('savedTemplates')) || [];
    }
    
    container.innerHTML = templates.map(template => `
        <div class="template-card">
            <h4>${template.title}</h4>
            <p>${template.description}</p>
            <div style="margin: 1rem 0; font-size: 0.8rem; color: #666;">
                ${template.fields ? template.fields.length : 0} fields
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                    ${template.category}
                </span>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="useTemplate(${template.id})">
                        Fill Out
                    </button>
                    <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="downloadTemplate(${template.id})">
                        Download
                    </button>
                </div>
            </div>
        </div>
    `).join('') + `
        <div class="template-card" style="border: 2px dashed #ddd; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #666;">
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">📋</div>
                <h4>Saved Templates</h4>
                <p>View your completed templates</p>
            </div>
            <button class="btn" onclick="showSavedTemplates()">
                View Saved (${savedTemplates.length})
            </button>
        </div>
    `;
}

// Also update the saveTemplateForm function to refresh the templates view:
function saveTemplateForm(event, templateId) {
    event.preventDefault();
    
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    const formData = new FormData(event.target);
    const savedTemplate = {
        id: Date.now(),
        templateId: templateId,
        title: document.getElementById('template_title').value,
        opportunityId: document.getElementById('template_opportunity').value || null,
        opportunityName: document.getElementById('template_opportunity').value ? 
            opportunities.find(o => o.id == document.getElementById('template_opportunity').value)?.name : null,
        savedDate: new Date().toISOString().split('T')[0],
        data: {}
    };
    
    // Collect all form data
    template.fields.forEach(field => {
        const value = formData.get(field.id);
        savedTemplate.data[field.id] = value || '';
    });
    
    savedTemplates.push(savedTemplate);
    localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
    
    closeTemplateDetailModal();
    alert('Template saved successfully!');
    
    // Refresh the templates view to show updated count
    if (document.getElementById('templates-view').style.display !== 'none') {
        renderTemplates();
    }
    
    // If we're on saved templates view, refresh it
    if (document.getElementById('saved-templates-view').style.display !== 'none') {
        renderSavedTemplates();
    }
}

function renderSavedTemplates() {
    const container = document.getElementById('saved-templates-grid');
    
    if (savedTemplates.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
                <h3>No saved templates yet</h3>
                <p>Fill out some templates to see them here</p>
                <button class="btn" onclick="showTemplates()" style="margin-top: 1rem;">Browse Templates</button>
            </div>
        `;
        return;
    }

    container.innerHTML = savedTemplates.map(saved => {
        const template = templates.find(t => t.id === saved.templateId);
        return `
            <div class="template-card">
                <h4>${saved.title}</h4>
                <p style="color: #666; font-size: 0.9rem;">${template ? template.title : 'Unknown Template'}</p>
                <div style="margin: 0.5rem 0; font-size: 0.8rem; color: #999;">
                    Saved: ${formatDate(saved.savedDate)}
                    ${saved.opportunityName ? ` • ${saved.opportunityName}` : ''}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <span style="background: #e8f5e9; color: #2e7d2e; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                        Completed
                    </span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="viewSavedTemplate(${saved.id})">
                            View
                        </button>
                        <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="downloadSavedTemplate(${saved.id})">
                            Export
                        </button>
                        <button class="btn btn-warning" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="deleteSavedTemplate(${saved.id})">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function useTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    const modal = document.getElementById('templateDetailModal');
    const content = document.getElementById('template-detail-content');
    
    // Generate form HTML
    const formHTML = `
        <h2>${template.title}</h2>
        <p style="color: #666; margin-bottom: 2rem;">${template.description}</p>
        
        <form id="templateForm" onsubmit="saveTemplateForm(event, ${templateId})">
            <div class="form-group">
                <label for="template_title">Template Title *</label>
                <input type="text" id="template_title" value="${template.title} - ${new Date().toLocaleDateString()}" required>
            </div>
            
            <div class="form-group">
                <label for="template_opportunity">Related Opportunity (Optional)</label>
                <select id="template_opportunity">
                    <option value="">Select Opportunity</option>
                    ${opportunities.map(opp => `<option value="${opp.id}">${opp.name}</option>`).join('')}
                </select>
            </div>
            
            <hr style="margin: 2rem 0;">
            
            ${template.fields.map(field => generateFormField(field)).join('')}
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeTemplateDetailModal()">Cancel</button>
                <button type="submit" class="btn">Save Template</button>
            </div>
        </form>
    `;
    
    content.innerHTML = formHTML;
    modal.style.display = 'block';
}

function generateFormField(field) {
    const required = field.required ? 'required' : '';
    const fieldId = `field_${field.id}`;
    
    switch (field.type) {
        case 'text':
            return `
                <div class="form-group">
                    <label for="${fieldId}">${field.label} ${field.required ? '*' : ''}</label>
                    <input type="text" id="${fieldId}" name="${field.id}" ${required}>
                </div>
            `;
        case 'number':
            const min = field.min !== undefined ? `min="${field.min}"` : '';
            const max = field.max !== undefined ? `max="${field.max}"` : '';
            return `
                <div class="form-group">
                    <label for="${fieldId}">${field.label} ${field.required ? '*' : ''}</label>
                    <input type="number" id="${fieldId}" name="${field.id}" ${min} ${max} ${required}>
                </div>
            `;
        case 'date':
            return `
                <div class="form-group">
                    <label for="${fieldId}">${field.label} ${field.required ? '*' : ''}</label>
                    <input type="date" id="${fieldId}" name="${field.id}" ${required}>
                </div>
            `;
        case 'textarea':
            return `
                <div class="form-group">
                    <label for="${fieldId}">${field.label} ${field.required ? '*' : ''}</label>
                    <textarea id="${fieldId}" name="${field.id}" rows="4" ${required}></textarea>
                </div>
            `;
        case 'select':
            return `
                <div class="form-group">
                    <label for="${fieldId}">${field.label} ${field.required ? '*' : ''}</label>
                    <select id="${fieldId}" name="${field.id}" ${required}>
                        <option value="">Select an option</option>
                        ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>
                </div>
            `;
        default:
            return '';
    }
}

function saveTemplateForm(event, templateId) {
    event.preventDefault();
    
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    const formData = new FormData(event.target);
    const savedTemplate = {
        id: Date.now(),
        templateId: templateId,
        title: document.getElementById('template_title').value,
        opportunityId: document.getElementById('template_opportunity').value || null,
        opportunityName: document.getElementById('template_opportunity').value ? 
            opportunities.find(o => o.id == document.getElementById('template_opportunity').value)?.name : null,
        savedDate: new Date().toISOString().split('T')[0],
        data: {}
    };
    
    // Collect all form data
    template.fields.forEach(field => {
        const value = formData.get(field.id);
        savedTemplate.data[field.id] = value || '';
    });
    
    savedTemplates.push(savedTemplate);
    localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
    
    closeTemplateDetailModal();
    alert('Template saved successfully!');
    
    // If we're on saved templates view, refresh it
    if (document.getElementById('saved-templates-view').style.display !== 'none') {
        renderSavedTemplates();
    }
}

function closeTemplateDetailModal() {
    document.getElementById('templateDetailModal').style.display = 'none';
}

function viewSavedTemplate(savedId) {
    const saved = savedTemplates.find(s => s.id === savedId);
    const template = templates.find(t => t.id === saved.templateId);
    
    if (!saved || !template) return;
    
    const modal = document.getElementById('templateDetailModal');
    const content = document.getElementById('template-detail-content');
    
    // Generate read-only view
    const viewHTML = `
        <h2>${saved.title}</h2>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
            <strong>Template:</strong> ${template.title}<br>
            <strong>Saved:</strong> ${formatDate(saved.savedDate)}<br>
            ${saved.opportunityName ? `<strong>Opportunity:</strong> ${saved.opportunityName}<br>` : ''}
        </div>
        
        <div style="max-height: 60vh; overflow-y: auto;">
            ${template.fields.map(field => {
                const value = saved.data[field.id] || 'Not provided';
                return `
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;">
                        <h4 style="color: #333; margin-bottom: 0.5rem;">${field.label}</h4>
                        <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 4px; white-space: pre-wrap;">${value}</div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeTemplateDetailModal()">Close</button>
            <button class="btn" onclick="downloadSavedTemplate(${savedId})">Export</button>
        </div>
    `;
    
    content.innerHTML = viewHTML;
    modal.style.display = 'block';
}

function downloadTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    // Create a simple text template
    const content = `${template.title}\n${'='.repeat(template.title.length)}\n\n${template.description}\n\n` +
        template.fields.map(field => `${field.label}:\n${field.required ? '(Required)' : '(Optional)'}\n\n\n`).join('');
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${template.title.replace(/\s+/g, '_')}_template.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadSavedTemplate(savedId) {
    const saved = savedTemplates.find(s => s.id === savedId);
    const template = templates.find(t => t.id === saved.templateId);
    
    if (!saved || !template) return;
    
    const content = `${saved.title}\n${'='.repeat(saved.title.length)}\n\n` +
        `Template: ${template.title}\n` +
        `Saved: ${formatDate(saved.savedDate)}\n` +
        `${saved.opportunityName ? `Opportunity: ${saved.opportunityName}\n` : ''}\n` +
        template.fields.map(field => {
            const value = saved.data[field.id] || 'Not provided';
            return `${field.label}:\n${value}\n`;
        }).join('\n');
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${saved.title.replace(/\s+/g, '_')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function deleteSavedTemplate(savedId) {
    if (!confirm('Are you sure you want to delete this saved template?')) return;
    
    savedTemplates = savedTemplates.filter(s => s.id !== savedId);
    localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
    renderSavedTemplates();
}

function clearAllSavedTemplates() {
    if (!confirm('Are you sure you want to delete ALL saved templates?')) return;
    
    savedTemplates = [];
    localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
    renderSavedTemplates();
}

// Update the window click handler to include the new modal
window.onclick = function(event) {
    const opportunityModal = document.getElementById('opportunityModal');
    const phaseModal = document.getElementById('phaseDetailModal');
    const templateModal = document.getElementById('templateDetailModal');
    const actionModal = document.getElementById('actionModal');

    if (event.target === opportunityModal) {
        closeModal();
    }
    if (event.target === phaseModal) {
        closePhaseModal();
    }
    if (event.target === templateModal) {
        closeTemplateDetailModal();
    }
    if (event.target === actionModal) {
        closeActionModal();
    }
}

        function showReports() {
            alert('Reports functionality coming soon!');
        }

function hideAllViews() {
    const views = ['dashboard-view', 'opportunities-view', 'roadmap-view', 'actions-view', 'templates-view', 'saved-templates-view'];
    views.forEach(viewId => {
        const element = document.getElementById(viewId);
        if (element) element.style.display = 'none';
    });
}

        function updateActiveNav(activeSection) {
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
                if (link.textContent === activeSection) {
                    link.classList.add('active');
                }
            });
        }

        // Dashboard functions
        function refreshDashboard() {
            updateMetrics();
            renderOpportunities('opportunity-list', opportunities);
            renderUrgentActions();
            renderSmartRecommendations();
        }

        function updateMetrics() {
            const totalPipeline = opportunities.reduce((sum, opp) => sum + opp.value, 0);
            const weightedPipeline = opportunities.reduce((sum, opp) => sum + (opp.value * opp.pwin / 100), 0);
            const avgProgress = Math.round(opportunities.reduce((sum, opp) => sum + opp.progress, 0) / opportunities.length);

            document.getElementById('total-pipeline').textContent = `${(totalPipeline / 1000000).toFixed(1)}M`;
            document.getElementById('weighted-pipeline').textContent = `${(weightedPipeline / 1000000).toFixed(1)}M`;
            document.getElementById('active-count').textContent = opportunities.length;
            document.getElementById('avg-progress').textContent = `${avgProgress}%`;
        }

        function renderSmartRecommendations() {
            const container = document.getElementById('smart-recommendations');
            const recommendations = generateSmartRecommendations();
            
            container.innerHTML = recommendations.map(rec => `
                <div class="next-action-item">
                    <div>
                        <strong>${rec.title}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${rec.description}</div>
                    </div>
                    <div style="color: #ffd700;">⭐ ${rec.priority}</div>
                </div>
            `).join('');
        }

        function generateSmartRecommendations() {
            const recommendations = [];
            
            opportunities.forEach(opp => {
                const daysToRfp = opp.rfpDate ? Math.ceil((new Date(opp.rfpDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                if (daysToRfp && daysToRfp < 60 && opp.progress < 70) {
                    recommendations.push({
                        title: `Accelerate ${opp.name}`,
                        description: `Only ${daysToRfp} days to RFP, currently ${opp.progress}% complete`,
                        priority: 'High'
                    });
                }
                
                if (opp.pwin < 50 && opp.currentPhase === 'engagement') {
                    recommendations.push({
                        title: `Improve positioning for ${opp.name}`,
                        description: `Low PWin (${opp.pwin}%) during engagement phase`,
                        priority: 'Medium'
                    });
                }
            });

            if (recommendations.length === 0) {
                recommendations.push({
                    title: 'Pipeline looking good!',
                    description: 'All opportunities are progressing well. Consider adding new prospects.',
                    priority: 'Low'
                });
            }

            return recommendations.slice(0, 3);
        }

        function renderUrgentActions() {
            const container = document.getElementById('urgent-actions');
            const urgentActions = actions.filter(action => {
                const dueDate = new Date(action.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return !action.completed && daysUntilDue <= 7;
            }).slice(0, 5);

            if (urgentActions.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No urgent actions</div>';
                return;
            }

            container.innerHTML = urgentActions.map(action => {
                const opportunity = opportunities.find(o => o.id === action.opportunityId);
                const dueDate = new Date(action.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isOverdue = daysUntilDue < 0;
                
                return `
                    <div class="action-item ${isOverdue ? 'urgent' : ''}">
                        <div>
                            <strong>${action.title}</strong>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${opportunity ? opportunity.name : 'Unknown Opportunity'} • ${action.phase}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: ${isOverdue ? '#dc3545' : '#ffc107'};">
                                ${isOverdue ? `${Math.abs(daysUntilDue)} days overdue` : `Due in ${daysUntilDue} days`}
                            </div>
                            <div style="margin-top: 0.3rem;">
                                <button class="btn btn-success" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="markActionComplete(${action.id})">Complete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Timeline Roadmap Functions
        function renderRoadmapTimeline() {
            const container = document.getElementById('roadmap-timeline-rows');
            
            container.innerHTML = opportunities.map(opp => {
                const daysToRfp = opp.rfpDate ? Math.ceil((new Date(opp.rfpDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                return `
                    <div class="timeline-row">
                        <div class="opportunity-info-cell">
                            <div class="opp-name">${opp.name}</div>
                            <div class="opp-details">
                                <strong>${opp.customer}</strong><br>
                                ${opp.type} • ${opp.role}${opp.incumbent ? ` • vs ${opp.incumbent}` : ''}
                            </div>
                            <div class="opp-metrics">
                                <div class="metric-badge value">
                                    💰 ${(opp.value / 1000000).toFixed(1)}M
                                </div>
                                <div class="metric-badge pwin-${opp.pwin >= 70 ? 'high' : opp.pwin >= 40 ? 'medium' : 'low'}">
                                    🎯 ${opp.pwin}%
                                </div>
                                <div class="metric-badge">
                                    📅 ${daysToRfp ? `${daysToRfp}d to RFP` : 'TBD'}
                                </div>
                            </div>
                        </div>
                        <div class="phase-blocks-container">
                            ${generatePhaseBlocks(opp, daysToRfp)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generatePhaseBlocks(opportunity, daysToRfp) {
            const phases = ['identification', 'qualification', 'planning', 'engagement', 'intelligence', 'preparation'];
            
            return phases.map(phaseKey => {
                const phase = captureRoadmap[phaseKey];
                const currentPhaseIndex = phases.indexOf(opportunity.currentPhase);
                const thisPhaseIndex = phases.indexOf(phaseKey);
                
                let status, icon, progress, statusText, className;
                
                if (thisPhaseIndex < currentPhaseIndex) {
                    // Completed phase
                    status = 'completed';
                    icon = '✅';
                    progress = '100%';
                    statusText = 'Complete';
                    className = 'completed';
                } else if (thisPhaseIndex === currentPhaseIndex) {
                    // Current phase - check if needs attention
                    const needsAttention = shouldPhaseNeedAttention(phaseKey, daysToRfp, opportunity.progress);
                    
                    if (needsAttention) {
                        status = 'needs-attention';
                        icon = '🎯';
                        progress = `${opportunity.progress}%`;
                        statusText = 'Needs Attention';
                        className = 'needs-attention';
                    } else {
                        status = 'current';
                        icon = '🔄';
                        progress = `${opportunity.progress}%`;
                        statusText = 'In Progress';
                        className = 'current';
                    }
                } else {
                    // Future phase
                    status = 'upcoming';
                    icon = '⏳';
                    progress = '0%';
                    statusText = 'Pending';
                    className = 'upcoming';
                }
                
                const tooltipText = generateTooltipText(opportunity, phase, status, daysToRfp);
                
                return `
                    <div class="phase-block ${className}" onclick="openPhaseDetail('${opportunity.id}', '${phaseKey}')">
                        <div class="phase-icon">${icon}</div>
                        <div class="phase-progress">${progress}</div>
                        <div class="phase-status">${statusText}</div>
                        <div class="tooltip">${tooltipText}</div>
                    </div>
                `;
            }).join('');
        }

        function shouldPhaseNeedAttention(phaseKey, daysToRfp, progress) {
            if (!daysToRfp || daysToRfp < 0) return false;
            
            // Define when phases should be completed based on days to RFP
            const phaseTimelines = {
                'identification': { shouldCompleteBy: 200, minProgress: 90 },
                'qualification': { shouldCompleteBy: 180, minProgress: 80 },
                'planning': { shouldCompleteBy: 150, minProgress: 70 },
                'engagement': { shouldCompleteBy: 120, minProgress: 60 },
                'intelligence': { shouldCompleteBy: 90, minProgress: 50 },
                'preparation': { shouldCompleteBy: 30, minProgress: 40 }
            };
            
            const timeline = phaseTimelines[phaseKey];
            if (!timeline) return false;
            
            // If we're close to RFP and progress is low, needs attention
            return daysToRfp <= timeline.shouldCompleteBy && progress < timeline.minProgress;
        }

        function generateTooltipText(opportunity, phase, status, daysToRfp) {
            let tooltip = `${phase.title}\n${phase.steps.length} steps`;
            
            switch(status) {
                case 'completed':
                    tooltip += '\n✅ Phase completed';
                    break;
                case 'current':
                    tooltip += `\n🔄 ${opportunity.progress}% complete`;
                    break;
                case 'needs-attention':
                    tooltip += `\n🎯 ${opportunity.progress}% - needs attention`;
                    break;
                case 'upcoming':
                    tooltip += '\n⏳ Not started';
                    break;
            }
            
            if (daysToRfp) {
                tooltip += `\n📅 ${daysToRfp} days to RFP`;
            }
            
            return tooltip;
        }

        function openPhaseDetail(opportunityId, phaseKey) {
            const opportunity = opportunities.find(opp => opp.id == opportunityId);
            const phase = captureRoadmap[phaseKey];
            
            if (!opportunity || !phase) return;
            
            const modal = document.getElementById('phaseDetailModal');
            const content = document.getElementById('phase-detail-content');
            
            // Calculate phase progress
            const completedSteps = getCompletedStepsForPhase(opportunityId, phaseKey);
            const totalSteps = phase.steps.length;
            const phaseProgress = Math.round((completedSteps / totalSteps) * 100);
            
            content.innerHTML = `
                <h2>${phase.title}</h2>
                <h3 style="color: #666; margin-bottom: 1rem;">${opportunity.name}</h3>
                <p style="margin-bottom: 1.5rem; color: #666;">${phase.description}</p>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4>Phase Progress: ${phaseProgress}% (${completedSteps}/${totalSteps} steps completed)</h4>
                    <div class="progress-bar" style="margin-top: 0.8rem; height: 8px;">
                        <div class="progress-fill" style="width: ${phaseProgress}%"></div>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    ${phase.steps.map((step, index) => {
                        const isCompleted = getStepCompletion(opportunityId, step.id);
                        const isCurrent = !isCompleted && index === completedSteps;
                        
                        return `
                            <div class="step-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h4>${isCompleted ? '✅' : isCurrent ? '🔄' : '⏳'} ${step.title}</h4>
                                    ${!isCompleted ? `<button class="btn btn-success" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="markStepComplete('${opportunityId}', '${step.id}')">Mark Complete</button>` : ''}
                                </div>
                                <p style="color: #666; margin-bottom: 0.5rem;">${step.description}</p>
                                <small style="color: #999;">Duration: ${step.duration} days • Start: Day ${step.daysFromStart}</small>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closePhaseModal()">Close</button>
                    <button class="btn" onclick="addPhaseAction('${opportunityId}', '${phaseKey}')">Add Action Item</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closePhaseModal() {
            document.getElementById('phaseDetailModal').style.display = 'none';
        }

        function getCompletedStepsForPhase(opportunityId, phaseKey) {
            const phase = captureRoadmap[phaseKey];
            if (!phase) return 0;
            
            return phase.steps.filter(step => getStepCompletion(opportunityId, step.id)).length;
        }

        function getStepCompletion(opportunityId, stepId) {
            return actions.some(action => 
                action.opportunityId == opportunityId && 
                action.stepId === stepId && 
                action.completed
            );
        }

        function markStepComplete(opportunityId, stepId) {
            // Find existing action or create new one
            let action = actions.find(a => a.opportunityId == opportunityId && a.stepId === stepId);
            
            if (!action) {
                // Create new action
                const stepInfo = findStepInfo(stepId);
                action = {
                    id: Date.now(),
                    opportunityId: parseInt(opportunityId),
                    title: stepInfo.title,
                    dueDate: new Date().toISOString().split('T')[0],
                    priority: "Medium",
                    phase: getCurrentPhaseForStep(stepId),
                    stepId: stepId,
                    completed: true
                };
                actions.push(action);
            } else {
                action.completed = true;
            }
            
            // Update opportunity progress
            updateOpportunityProgress(opportunityId);
            
            // Refresh views
            renderRoadmapTimeline();
            refreshDashboard();
            
            // Close and reopen modal to refresh
            closePhaseModal();
            setTimeout(() => openPhaseDetail(opportunityId, getCurrentPhaseForStep(stepId)), 100);
        }

        function findStepInfo(stepId) {
            for (const phase of Object.values(captureRoadmap)) {
                const step = phase.steps.find(s => s.id === stepId);
                if (step) return step;
            }
            return { title: "Unknown Step", description: "" };
        }

        function getCurrentPhaseForStep(stepId) {
            for (const [phaseKey, phase] of Object.entries(captureRoadmap)) {
                if (phase.steps.some(s => s.id === stepId)) {
                    return phaseKey;
                }
            }
            return "unknown";
        }

        function updateOpportunityProgress(opportunityId) {
            const opportunity = opportunities.find(o => o.id == opportunityId);
            if (!opportunity) return;
            
            let totalSteps = 0;
            let completedSteps = 0;
            
            Object.values(captureRoadmap).forEach(phase => {
                phase.steps.forEach(step => {
                    totalSteps++;
                    if (getStepCompletion(opportunityId, step.id)) {
                        completedSteps++;
                    }
                });
            });
            
            opportunity.progress = Math.round((completedSteps / totalSteps) * 100);
            
            // Update current phase based on progress
            const phases = ['identification', 'qualification', 'planning', 'engagement', 'intelligence', 'preparation'];
            if (opportunity.progress < 15) opportunity.currentPhase = 'identification';
            else if (opportunity.progress < 30) opportunity.currentPhase = 'qualification';
            else if (opportunity.progress < 50) opportunity.currentPhase = 'planning';
            else if (opportunity.progress < 70) opportunity.currentPhase = 'engagement';
            else if (opportunity.progress < 85) opportunity.currentPhase = 'intelligence';
            else opportunity.currentPhase = 'preparation';
        }

        function addPhaseAction(opportunityId, phaseKey) {
            const opportunity = opportunities.find(o => o.id == opportunityId);
            const phase = captureRoadmap[phaseKey];
            
            if (!opportunity || !phase) return;
            
            const title = prompt(`Add action item for ${phase.title}:`);
            const dueDate = prompt('Due date (YYYY-MM-DD):', new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            
            if (title && dueDate) {
                const newAction = {
                    id: Date.now(),
                    opportunityId: parseInt(opportunityId),
                    title: title,
                    dueDate: dueDate,
                    priority: "Medium",
                    phase: phaseKey,
                    stepId: `custom-${Date.now()}`,
                    completed: false
                };
                
                actions.push(newAction);
                refreshDashboard();
                alert('Action item added successfully!');
            }
        }

        function refreshRoadmapView() {
            renderRoadmapTimeline();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Refreshed';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function exportRoadmap() {
            // Simple CSV export of roadmap data
            const csvData = opportunities.map(opp => {
                const daysToRfp = opp.rfpDate ? Math.ceil((new Date(opp.rfpDate) - new Date()) / (1000 * 60 * 60 * 24)) : 'TBD';
                return `"${opp.name}","${opp.customer}","${opp.currentPhase}",${opp.progress},"${opp.pwin}%","${(opp.value/1000000).toFixed(1)}M","${daysToRfp}"`;
            });
            
            const csvContent = ['Name,Customer,Current Phase,Progress,PWin,Value,Days to RFP', ...csvData].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'capture_roadmap.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Modal functions
        function openNewOpportunityModal() {
            document.getElementById('opportunityModal').style.display = 'block';
            document.getElementById('opportunityForm').reset();
        }

        function closeModal() {
            document.getElementById('opportunityModal').style.display = 'none';
        }

        function openNewActionModal() {
        document.getElementById('actionModal').style.display = 'block';
        document.getElementById('actionForm').reset();
    
        // Populate opportunity dropdown
        const opportunitySelect = document.getElementById('actionOpportunity');
        opportunitySelect.innerHTML = '<option value="">Select Opportunity</option>';
    
        opportunities.forEach(opp => {
            const option = document.createElement('option');
            option.value = opp.id;
            option.textContent = opp.name;
            opportunitySelect.appendChild(option);
            });
        }

        function closeActionModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        function openNewTemplateModal() {
            alert('Add Template functionality coming soon!');
        }

        // Opportunity management
        function renderOpportunities(container, opportunitiesList = opportunities) {
            const container_element = document.getElementById(container);
            if (!container_element) return;

            if (opportunitiesList.length === 0) {
                container_element.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No opportunities found</div>';
                return;
            }

            container_element.innerHTML = opportunitiesList.map(opp => `
                <div class="opportunity-item">
                    <div class="opportunity-info">
                        <h4>${opp.name}</h4>
                        <div class="opportunity-details">
                            ${opp.customer} • ${opp.type} • ${opp.role}
                            ${opp.incumbent ? ` • Incumbent: ${opp.incumbent}` : ''}
                        </div>
                    </div>
                    <div class="status-badge status-${opp.currentPhase}">
                        ${opp.currentPhase.charAt(0).toUpperCase() + opp.currentPhase.slice(1)}
                    </div>
                    <div class="progress-indicator">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${opp.progress}%"></div>
                        </div>
                        <small>${opp.progress}%</small>
                    </div>
                    <div class="pwin-indicator pwin-${opp.pwin >= 70 ? 'high' : opp.pwin >= 40 ? 'medium' : 'low'}">
                        ${opp.pwin}%
                    </div>
                    <div style="text-align: right; font-size: 0.9rem;">
                        <strong>${(opp.value / 1000000).toFixed(1)}M</strong>
                        <div style="color: #666; font-size: 0.8rem;">
                            ${opp.rfpDate ? formatDate(opp.rfpDate) : 'TBD'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderAllOpportunities() {
            renderOpportunities('all-opportunities', opportunities);
        }

        function saveOpportunity(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const newOpportunity = {
                id: Date.now(),
                name: document.getElementById('oppName').value,
                customer: document.getElementById('oppCustomer').value,
                value: parseInt(document.getElementById('oppValue').value) || 0,
                rfpDate: document.getElementById('oppRfpDate').value,
                pwin: parseInt(document.getElementById('oppPwin').value) || 50,
                type: document.getElementById('oppType').value,
                role: document.getElementById('oppRole').value,
                incumbent: document.getElementById('oppIncumbent').value,
                description: document.getElementById('oppDescription').value,
                currentPhase: 'identification',
                progress: 5,
                createdDate: new Date().toISOString().split('T')[0]
            };
            
            opportunities.push(newOpportunity);
            closeModal();
            refreshDashboard();
            
            if (document.getElementById('roadmap-view').style.display !== 'none') {
                renderRoadmapTimeline();
            }
            if (document.getElementById('opportunities-view').style.display !== 'none') {
                renderAllOpportunities();
            }
            
            alert('Opportunity added successfully!');
        }

    function saveAction(event) {
            event.preventDefault();
    
            const newAction = {
                id: Date.now(),
                opportunityId: parseInt(document.getElementById('actionOpportunity').value),
                title: document.getElementById('actionTitle').value,
                dueDate: document.getElementById('actionDueDate').value,
                priority: document.getElementById('actionPriority').value,
                phase: document.getElementById('actionPhase').value,
                category: document.getElementById('actionCategory').value,
                description: document.getElementById('actionDescription').value,
                completed: false
            };
    
        actions.push(newAction);
        closeActionModal();
        refreshDashboard();
    
        if (document.getElementById('actions-view').style.display !== 'none') {
            renderAllActions();
        }
    
        alert('Action item added successfully!');
    }

        // Actions management
        function renderAllActions() {
            const container = document.getElementById('all-actions');
            
            if (actions.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No action items found</div>';
                return;
            }

            const sortedActions = [...actions].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            container.innerHTML = sortedActions.map(action => {
                const opportunity = opportunities.find(o => o.id === action.opportunityId);
                const dueDate = new Date(action.dueDate);
                const today = new Date();
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isOverdue = daysUntilDue < 0 && !action.completed;
                
                return `
                    <div class="action-item ${isOverdue ? 'urgent' : ''} ${action.completed ? 'completed' : ''}">
                        <div>
                            <strong>${action.title}</strong>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${opportunity ? opportunity.name : 'Unknown Opportunity'} • ${action.phase} • Priority: ${action.priority}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: ${action.completed ? '#28a745' : isOverdue ? '#dc3545' : '#666'};">
                                ${action.completed ? 'Completed' : isOverdue ? `${Math.abs(daysUntilDue)} days overdue` : `Due: ${formatDate(action.dueDate)}`}
                            </div>
                            ${!action.completed ? `<div style="margin-top: 0.3rem;">
                                <button class="btn btn-success" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="markActionComplete(${action.id})">Complete</button>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markActionComplete(actionId) {
            const action = actions.find(a => a.id === actionId);
            if (action) {
                action.completed = true;
                refreshDashboard();
                if (document.getElementById('actions-view').style.display !== 'none') {
                    renderAllActions();
                }
            }
        }

        // Templates management
//        function renderTemplates() {
//            const container = document.getElementById('templates-grid');
//            
//            container.innerHTML = templates.map(template => `
//                <div class="template-card">
//                    <h4>${template.title}</h4>
//                    <p>${template.description}</p>
//                    <div style="display: flex; justify-content: space-between; align-items: center;">
//                        <span style="background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
//                            ${template.category}
//                        </span>
//                        <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="useTemplate(${template.id})">
//                            Use Template
//                        </button>
//                    </div>
//                </div>
//            `).join('');
//        }

//        function useTemplate(templateId) {
//            const template = templates.find(t => t.id === templateId);
//            if (template) {
//                // Create a downloadable text file
//                const blob = new Blob([template.content], { type: 'text/plain' });
//                const url = URL.createObjectURL(blob);
//                const a = document.createElement('a');
//                a.href = url;
//                a.download = `${template.title.replace(/\s+/g, '_')}.txt`;
//                a.click();
//                URL.revokeObjectURL(url);
//            }
//        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const opportunityModal = document.getElementById('opportunityModal');
            const phaseModal = document.getElementById('phaseDetailModal');
            
            if (event.target === opportunityModal) {
                closeModal();
            }
            if (event.target === phaseModal) {
                closePhaseModal();
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            showDashboard();
        });
    </script>
</body>
</html>